<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>All Posts</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 0;
            color: #000;
            background-color: #fff;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        /* Filters Section */
        .filters {
            border: 1px solid #000;
            padding: 15px;
            margin-bottom: 20px;
            max-width: 900px;
        }

        .filter-group {
            margin-bottom: 10px;
        }

        label {
            margin-right: 10px;
        }

        input[type="checkbox"], input[type="text"] {
            margin-right: 5px;
        }

        /* Post Card */
        .post {
            border: 1px solid #000;
            padding: 15px;
            margin-bottom: 15px;
            max-width: 900px;
        }

        .post-title {
            font-weight: bold;
        }

        .post-author {
            font-style: italic;
            margin-left: 5px;
        }

        .post-content {
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .meta {
            font-size: 0.85em;
            color: #333;
        }

        .post-link {
            margin-top: 10px;
        }

        button {
            padding: 5px 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<!-- User Actions -->
<div th:if="${currentUser != null}" style="display: flex; align-items: center; gap: 20px;">
    <!-- Show current user name -->
    <span>Logged in as: <b th:text="${currentUser.name}">User Name</b></span>

    <!-- Only show for non-admin users -->
    <a th:if="${currentUser.role != T(com.mountblue.blogapplication.model.Role).ADMIN}"
       th:href="@{/posts/my}">View My Posts</a>


    <!-- Always show for logged-in users -->
    <a th:href="@{/post/create}">Create New Post</a>
</div>

<h1>All Posts</h1>

<!-- ===== Filters & Search Form ===== -->
<form th:action="@{/}" th:object="${filterDTO}" method="get" class="filters">
    <div class="filter-group">
        <span>Authors:</span>
        <span th:each="author : ${authors}">
            <label>
                <input type="checkbox" th:field="*{authors}" th:value="${author.name}"/>
                <span th:text="${author.name}"></span>
            </label>
        </span>
    </div>

    <div class="filter-group">
        <span>Tags:</span>
        <span th:each="tag : ${tags}">
            <label>
                <input type="checkbox" th:field="*{tags}" th:value="${tag.name}"/>
                <span th:text="${tag.name}"></span>
            </label>
        </span>
    </div>

    <div class="filter-group">
        <span>Published Between:</span>
        <input type="date" name="startPublishDate" th:value="${filter?.startPublishDate}"/>
        <input type="date" name="endPublishDate" th:value="${filter?.endPublishDate}"/>
    </div>

    <div class="filter-group">
        <label for="search">Search:</label>
        <input type="text" id="search" th:field="*{search}" placeholder="Search posts"/>
    </div>

    <div class="filter-group">
        <label for="sortField">Sort By:</label>
        <select id="sortField" th:field="*{sortField}">
            <option value="publishedAt">Published Date</option>
            <option value="title">Title</option>
        </select>

        <select th:field="*{order}">
            <option value="asc">Asc</option>
            <option value="desc">Desc</option>
        </select>
    </div>

    <button type="submit">Filter</button>
</form>

<!-- ===== For Post ===== -->
<div th:each="post : ${filteredPost.content}" class="post">
    <div>
        <span class="post-title" th:text="${post.title}">Post Title</span> |
        <span class="post-author" th:text="${post.author.name}">Author</span>
    </div>

    <div class="post-content">
        <span th:text="${#strings.length(post.content) > 30} ? ${post.content.substring(0,30)} + '...' : ${post.content}"></span>
        <a th:if="${#strings.length(post.content) > 30}" th:href="@{'/post/' + ${post.id}}">Read more</a>
    </div>

    <div class="meta">
        <span>Published: </span>
        <span th:text="${post.publishedAt != null ? #temporals.format(post.publishedAt,'dd MMM yyyy HH:mm') : 'Wait for update'}"></span>
        <br/>
        <span>Created: </span>
        <span th:text="${#temporals.format(post.createdAt,'dd MMM yyyy HH:mm')}"></span> |
        <span>Updated: </span>
        <span th:text="${#temporals.format(post.updatedAt,'dd MMM yyyy HH:mm')}"></span>
    </div>

    <div class="post-link">
        <a th:href="@{/post/{id}(id=${post.id})}">
            <button>View Post</button>
        </a>
    </div>
</div>

<!-- ===== Pagination Controls ===== -->
<div class="pagination">
    <form th:action="@{/}" th:object="${filterDTO}" method="get">
        <!-- Preserve filters -->
        <input type="hidden" th:field="*{authors}"/>
        <input type="hidden" th:field="*{tags}"/>
        <input type="hidden" th:field="*{search}"/>
        <input type="hidden" th:field="*{sortField}"/>
        <input type="hidden" th:field="*{order}"/>
        <input type="hidden" th:field="*{startPublishDate}"/>
        <input type="hidden" th:field="*{endPublishDate}"/>

        <button type="submit"
                th:disabled="${!filteredPost.hasPrevious()}"
                th:attr="name='page', value=${filteredPost.number - 1}">
            Previous
        </button>

        <span th:text="'Page ' + ${filteredPost.number + 1} + ' of ' + ${filteredPost.totalPages}"></span>

        <button type="submit"
                th:disabled="${!filteredPost.hasNext()}"
                th:attr="name='page', value=${filteredPost.number + 1}">
            Next
        </button>
    </form>
</div>


</body>
</html>
